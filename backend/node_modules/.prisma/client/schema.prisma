generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id           String    @id @default(cuid())
  name         String
  email        String    @unique
  phone        String?
  role         String
  department   String?
  passwordHash String    @map("password_hash")
  isOnline     Boolean   @default(false) @map("is_online")
  lastSeen     DateTime? @map("last_seen")

  // Leaderboard fields
  points                     Int       @default(0)
  level                      Int       @default(1)
  ticketsResolved            Int       @default(0) @map("tickets_resolved")
  averageResolutionTimeHours Float?    @map("average_resolution_time_hours")
  customerSatisfactionRating Float?    @map("customer_satisfaction_rating")
  currentStreak              Int       @default(0) @map("current_streak")
  totalTicketsHandled        Int       @default(0) @map("total_tickets_handled")
  averageResponseTimeMinutes Float?    @map("average_response_time_minutes")
  monthlyGrowth              Float     @default(0) @map("monthly_growth")
  specialRecognition         String?   @map("special_recognition")
  lastActiveDate             DateTime? @map("last_active_date")

  // Notification preferences
  emailNotificationsEnabled Boolean @default(true) @map("email_notifications_enabled")
  inAppNotificationsEnabled Boolean @default(true) @map("in_app_notifications_enabled")
  notifyOnTicketSubmitted   Boolean @default(true) @map("notify_on_ticket_submitted")
  notifyOnStaffReply        Boolean @default(true) @map("notify_on_staff_reply")
  notifyOnStatusChange      Boolean @default(true) @map("notify_on_status_change")

  createdAt           DateTime                     @default(now()) @map("created_at")
  updatedAt           DateTime                     @updatedAt @map("updated_at")
  sentMessages        TicketMessage[]
  assignedTickets     Ticket[]                     @relation("AssignedTickets")
  createdTickets      Ticket[]                     @relation("CustomerTickets")
  achievements        UserAchievement[]
  chatMessages        ChatMessage[]
  satisfactionSurveys CustomerSatisfactionSurvey[]

  @@map("users")
}

model Achievement {
  id           String   @id @default(cuid())
  name         String   @unique
  description  String
  icon         String // Icon name (star, zap, crown, target, award, etc.)
  color        String // Color variant (bronze, silver, gold, purple, blue, green)
  pointsReward Int      @default(0) @map("points_reward")
  requirements String // JSON string of requirements
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  userAchievements UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String   @id @default(cuid())
  userId        String   @map("user_id")
  achievementId String   @map("achievement_id")
  unlockedAt    DateTime @default(now()) @map("unlocked_at")

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@map("user_achievements")
}

model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  tickets     Ticket[]

  @@map("categories")
}

model Ticket {
  id                String    @id
  customerId        String    @map("customer_id")
  assignedStaffId   String?   @map("assigned_staff_id")
  categoryId        String    @map("category_id")
  priority          String
  status            String
  subject           String
  description       String
  resolutionTime    Float?    @map("resolution_time") // in hours
  firstResponseTime Float?    @map("first_response_time") // in minutes
  customerRating    Int?      @map("customer_rating") // 1-5 stars
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  resolvedAt        DateTime? @map("resolved_at")

  messages           TicketMessage[]
  category           Category                    @relation(fields: [categoryId], references: [id])
  assignedStaff      User?                       @relation("AssignedTickets", fields: [assignedStaffId], references: [id])
  customer           User                        @relation("CustomerTickets", fields: [customerId], references: [id])
  satisfactionSurvey CustomerSatisfactionSurvey?

  @@map("tickets")
}

model TicketMessage {
  id             String   @id @default(cuid())
  ticketId       String   @map("ticket_id")
  senderId       String   @map("sender_id")
  message        String
  attachmentUrls String   @default("[]") @map("attachment_urls")
  isInternal     Boolean  @default(false) @map("is_internal")
  createdAt      DateTime @default(now()) @map("created_at")
  sender         User     @relation(fields: [senderId], references: [id])
  ticket         Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@map("ticket_messages")
}

model ChatMessage {
  id        String   @id @default(cuid())
  senderId  String   @map("sender_id")
  message   String
  isEdited  Boolean  @default(false) @map("is_edited")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  sender User @relation(fields: [senderId], references: [id])

  @@map("chat_messages")
}

model CustomerSatisfactionSurvey {
  id         String @id @default(cuid())
  ticketId   String @unique @map("ticket_id")
  customerId String @map("customer_id")

  // Survey Questions
  overallRating     Int? @map("overall_rating") // 1-5 stars
  responseTime      Int? @map("response_time") // 1-5 stars  
  helpfulness       Int? @map("helpfulness") // 1-5 stars
  professionalism   Int? @map("professionalism") // 1-5 stars
  resolutionQuality Int? @map("resolution_quality") // 1-5 stars

  // Text Feedback
  feedback     String? @map("feedback") // Optional written feedback
  improvements String? @map("improvements") // What could be improved

  // Survey Status
  isCompleted   Boolean   @default(false) @map("is_completed")
  completedAt   DateTime? @map("completed_at")
  emailSent     Boolean   @default(false) @map("email_sent")
  remindersSent Int       @default(0) @map("reminders_sent")

  // Metadata
  surveyVersion    String  @default("1.0") @map("survey_version")
  ipAddress        String? @map("ip_address")
  userAgent        String? @map("user_agent")
  timeSpentSeconds Int?    @map("time_spent_seconds")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  ticket   Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  customer User   @relation(fields: [customerId], references: [id])

  @@map("customer_satisfaction_surveys")
}
